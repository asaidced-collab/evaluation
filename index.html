<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحكيم أداة قياس الممارسات التربوية الدامجة</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; line-height: 1.6;
        }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(45deg, #2c3e50, #3498db); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .content { padding: 40px; }
        .page { display: none; animation: fadeIn 0.5s ease-in; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        
        .progress-container { margin-bottom: 30px; }
        .progress-bar { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #3498db, #2980b9); border-radius: 4px; transition: width 0.5s ease; width: 0%; }
        .progress-text { text-align: center; margin-top: 8px; font-size: 0.9em; color: #666; }
        
        .save-status { 
            position: fixed; bottom: 20px; right: 20px; 
            background: #27ae60; color: white; padding: 10px 15px; 
            border-radius: 25px; font-size: 0.9em; z-index: 1000;
            opacity: 0; transition: opacity 0.3s;
        }
        .save-status.show { opacity: 1; }
        
        .page-title { font-size: 1.8em; color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #3498db; }
        .page-subtitle { font-size: 1.1em; color: #666; margin-bottom: 25px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        
        .info-box { background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 25px 0; border-left: 5px solid #27ae60; }
        .info-box h3 { color: #27ae60; margin-bottom: 10px; }
        .info-box p { margin-bottom: 8px; }
        
        .expert-role-box { background: #fff3cd; padding: 20px; border-radius: 10px; margin: 25px 0; border-left: 5px solid #ffc107; }
        .expert-role-box h3 { color: #856404; margin-bottom: 10px; }
        
        .researcher-info-box { background: #d1ecf1; padding: 20px; border-radius: 10px; margin: 25px 0; border-left: 5px solid #17a2b8; }
        .researcher-info-box h3 { color: #0c5460; margin-bottom: 10px; }
        .researcher-info-box p { margin-bottom: 5px; color: #0c5460; }
        
        .privacy-info-box { background: #f8d7da; padding: 20px; border-radius: 10px; margin: 25px 0; border-left: 5px solid #dc3545; }
        .privacy-info-box h3 { color: #721c24; margin-bottom: 10px; }
        .privacy-info-box p { margin-bottom: 5px; color: #721c24; }
        
        .axis-header { 
            background: linear-gradient(45deg, #3498db, #2980b9); 
            color: white; padding: 20px; margin: 25px 0 15px 0; 
            border-radius: 10px; text-align: center;
        }
        .axis-header h3 { font-size: 1.3em; margin-bottom: 8px; }
        .axis-header p { font-size: 0.95em; opacity: 0.9; }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .form-group input.invalid { border-color: #e74c3c; background-color: #fff5f5; }
        
        .btn { 
            background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; 
            padding: 15px 30px; border-radius: 8px; font-size: 1.1em; cursor: pointer; 
            transition: all 0.3s; margin: 10px 5px; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        
        .navigation-buttons { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; 
        }
        
        .error-message { 
            color: #e74c3c; background: #fdf2f2; padding: 10px; border-radius: 5px; 
            margin-top: 10px; display: none; 
        }
        
        .summary-section { 
            background: #e8f5e8; padding: 25px; border-radius: 10px; margin: 20px 0;
            border-left: 5px solid #27ae60;
        }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-box { 
            background: white; padding: 20px; border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;
        }
        .stat-box h4 { color: #2980b9; margin-bottom: 15px; }
        .stat-box .stat-number { font-size: 2em; font-weight: bold; color: #27ae60; }
        
        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 10px; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 تحكيم أداة قياس الممارسات التربوية الدامجة</h1>
            <p>مقياس ممارسات الأستاذ المغربي للتربية الدامجة (التلاميذ في وضعية إعاقة ذهنية)</p>
        </div>

        <div class="content">
            <div class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText"></div>
            </div>

            <!-- صفحة الترحيب -->
            <div class="page active" id="page0">
                <div class="page-title">مرحباً بكم في تحكيم الأداة البحثية</div>
                
                <div class="researcher-info-box">
                    <h3>📋 معلومات الباحث</h3>
                    <p><strong>الباحث:</strong> عبد المجيد سعيد - طالب دكتوراه</p>
                    <p><strong>الجامعة:</strong> جامعة القاضي عياض، مراكش - المغرب</p>
                    <p><strong>التخصص:</strong> علم النفس الاجتماعي</p>
                    <p><strong>الغرض:</strong> سيُوظف هذا المقياس في إطار البحث الأكاديمي</p>
                    <p><strong>التواصل:</strong> a.said.ced@uca.ac.ma</p>
                </div>

                <div class="privacy-info-box">
                    <h3>🔒 سرية البيانات والمشاركة</h3>
                    <p>• جميع المعلومات سرية ولن تُستخدم إلا لأغراض البحث العلمي</p>
                    <p>• لن يتم نشر أسماء المحكمين أو ربط البيانات بهويتكم</p>
                    <p>• المشاركة اختيارية ويمكنكم التوقف في أي وقت</p>
                    <p>• البيانات محفوظة وفق معايير الأمان الأكاديمي</p>
                </div>
                
                <div class="info-box">
                    <h3>🎯 الأداة المراد تحكيمها:</h3>
                    <p><strong>العنوان:</strong> مقياس ممارسات الأستاذ المغربي للتربية الدامجة (التلاميذ في وضعية إعاقة ذهنية)</p>
                    <p><strong>الفئة المستهدفة:</strong> أساتذة التعليم الابتدائي المغاربة العاملون مع تلاميذ في وضعية إعاقة ذهنية</p>
                    <p><strong>نوع التقييم:</strong> تقييم ذاتي للأستاذ حول ممارساته المهنية</p>
                    <p><strong>طبيعة المقياس:</strong> يقيس التطبيق الفعلي للممارسات الدامجة (وليس المعرفة النظرية)</p>
                    <p><strong>ملاحظة مهمة:</strong> المقياس يحتوي على عبارات سالبة وإيجابية، وسيعرض على الأستاذ النهائي بشكل غير مرتب في محاور</p>
                    <p><strong>لأغراض التحكيم:</strong> البنود معروضة مرتبة في محاور لتسهيل التقييم، لكن الأستاذ النهائي سيراها مختلطة</p>
                </div>

                <div class="expert-role-box">
                    <h3>📋 دورك كمحكم:</h3>
                    <p>هذا المقياس موجه للأساتذة الدامجين، حيث يقيم كل أستاذ <strong>ذاتياً</strong> مدى تطبيقه للممارسات التربوية الدامجة باستخدام مقياس ليكرت الخماسي (دائماً - غالباً - أحياناً - نادراً - نادراً جداً). دورك كمحكم هو تقييم مدى <strong>ملاءمة ووضوح وضرورة</strong> البنود التي ستُعرض على الأساتذة لتقييم ممارساتهم.</p>
                </div>

                <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 10px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #155724; margin-bottom: 10px;">⏱️ ما المطلوب منكم:</h4>
                    <p style="color: #155724; margin: 5px 0;">• تقييم <strong><span id="total-items-span"></span></strong> بند موزعة على <strong><span id="total-axes-span"></span></strong> محاور</p>
                    <p style="color: #155724; margin: 5px 0;">• لكل بند: 3 تقييمات رقمية من 1-5 (ملاءمة، وضوح، ضرورة)</p>
                    <p style="color: #155724; margin: 5px 0;">• تعليق اختياري على كل محور</p>
                    <p style="color: #155724; margin: 5px 0;">• الوقت المتوقع: 25-35 دقيقة</p>
                    <p style="color: #155724; margin: 5px 0;">• الحفظ التلقائي: كل 30 ثانية</p>
                </div>

                <div class="navigation-buttons">
                    <div></div>
                    <button class="btn" onclick="nextPage()">🚀 البدء في التحكيم</button>
                </div>
            </div>

            <!-- صفحة بيانات المحكم -->
            <div class="page" id="page1">
                <div class="page-title">بيانات المحكم</div>
                <div class="page-subtitle">معلومات عامة تساعد في توثيق عملية التحكيم</div>

                <div class="form-group">
                    <label>اسم المحكم *</label>
                    <input type="text" name="expert_name" placeholder="الاسم الكامل">
                </div>

                <div class="form-group">
                    <label>الصفة/الدور *</label>
                    <select name="expert_role">
                        <option value="">اختر الصفة/الدور...</option>
                        <option value="أستاذ جامعي متخصص في التربية الدامجة">أستاذ جامعي متخصص في التربية الدامجة</option>
                        <option value="باحث في التربية الخاصة/الدامجة">باحث في التربية الخاصة/الدامجة</option>
                        <option value="مفتش تربوي (تعليم ابتدائي)">مفتش تربوي (تعليم ابتدائي)</option>
                        <option value="خبير في التربية الدامجة">خبير في التربية الدامجة</option>
                        <option value="مكون في مجال التربية الدامجة">مكون في مجال التربية الدامجة</option>
                        <option value="مستشار في التربية الخاصة">مستشار في التربية الخاصة</option>
                        <option value="أخرى">أخرى (يرجى التحديد أدناه)</option>
                    </select>
                </div>

                <div class="form-group" id="other-role-group" style="display: none;">
                    <label>يرجى تحديد الصفة/الدور:</label>
                    <input type="text" name="expert_role_other" placeholder="اذكر الصفة...">
                </div>

                <div class="form-group">
                    <label>سنوات الخبرة في مجال التربية الدامجة/الخاصة *</label>
                    <input type="number" name="years_experience" min="0" max="50" placeholder="عدد السنوات">
                </div>

                <div class="form-group">
                    <label>طبيعة الخبرة في التربية الدامجة</label>
                    <select name="experience_type">
                        <option value="">اختر طبيعة الخبرة...</option>
                        <option value="بحث أكاديمي وعلمي">بحث أكاديمي وعلمي</option>
                        <option value="تكوين وتدريب الأساتذة">تكوين وتدريب الأساتذة</option>
                        <option value="تفتيش وإشراف تربوي">تفتيش وإشراف تربوي</option>
                        <option value="استشارة ومرافقة ميدانية">استشارة ومرافقة ميدانية</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>البريد الإلكتروني (اختياري)</label>
                    <input type="email" name="email" placeholder="your@email.com">
                </div>

                <div class="error-message" id="error1"></div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="prevPage()">السابق</button>
                    <button class="btn" onclick="nextPage()">التالي</button>
                </div>
            </div>

            <!-- صفحة الملخص النهائي -->
            <div class="page" id="summary-page">
                <div class="page-title">📊 ملخص تحكيمك</div>
                
                <div class="summary-section">
                    <h3 style="color: #27ae60; margin-bottom: 15px;">إحصائيات التحكيم</h3>
                    <div class="summary-stats">
                        <div class="stat-box">
                            <h4>البنود المكتملة</h4>
                            <div class="stat-number" id="completed-items">0/0</div>
                        </div>
                        <div class="stat-box">
                            <h4>متوسط الملاءمة</h4>
                            <div class="stat-number" id="avg-relevance">0.0/5</div>
                        </div>
                        <div class="stat-box">
                            <h4>متوسط الوضوح</h4>
                            <div class="stat-number" id="avg-clarity">0.0/5</div>
                        </div>
                        <div class="stat-box">
                            <h4>متوسط الضرورة</h4>
                            <div class="stat-number" id="avg-necessity">0.0/5</div>
                        </div>
                    </div>
                    
                    <div id="low-rated-items" style="margin-top: 20px;">
                        <h4 style="color: #e67e22;">⚠️ بنود تحتاج مراجعة (أقل من 4 نقاط):</h4>
                        <div id="low-rated-list"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>هل توجد بنود مهمة مفقودة تقترحون إضافتها؟</label>
                    <textarea name="missing_items" rows="4" placeholder="اذكروا البنود المهمة التي ترون ضرورة إضافتها..."></textarea>
                </div>

                <div class="form-group">
                    <label>اقتراحات أخرى لتحسين الاستمارة</label>
                    <textarea name="improvement_suggestions" rows="4" placeholder="أي اقتراحات أخرى لتطوير وتحسين الاستمارة..."></textarea>
                </div>

                <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 10px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #155724; margin-bottom: 10px;">🎉 شكراً جزيلاً لكم!</h4>
                    <p style="color: #155724; margin: 0;">
                        مساهمتكم القيمة ستساعد في تطوير أداة بحثية عالية الجودة تخدم التربية الدامجة في المغرب.
                    </p>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="prevPage()">السابق</button>
                    <button class="btn" onclick="submitForm()">📤 إرسال التحكيم النهائي</button>
                </div>
            </div>
        </div>
    </div>

    <div class="save-status" id="saveStatus">💾 تم الحفظ تلقائياً</div>

    <script>
        // ===== إعدادات أساسية =====
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymJx9JEU0WqNlLaqABuTiSszKx14m9inMm7dW_Y8NT3e08ayco_ut4fYLPBuVcgy0xBg/exec';

        // ===== المحاور والبنود المحدثة =====
        const AXIS_INFO = [
            {
                title: "المحور الأول: التشخيص وبناء المشاريع",
                description: "يقيس هذا المحور قدرة الأستاذ الدامج على تشخيص شامل لقدرات وحاجات التلميذ، وبناء مشاريع تربوية فردية قائمة على أهداف واضحة وقابلة للقياس، وتوثيق مسار التعلم، والعمل التشاركي مع الفريق المتعدد التخصصات. (البند 5 سالب)",
                startIndex: 1,
                items: [
                    { id: 1, text: "أجمع معلومات شاملة عن التلميذ من مصادر متعددة (الأسرة، التقارير الطبية، الملاحظة المباشرة) كي أشخص قدراته وحاجاته.", negative: false },
                    { id: 2, text: "أبني مشروعاً بيداغوجياً فردياً (PPI) مفصلاً لكل تلميذ في وضعية إعاقة ذهنية.", negative: false },
                    { id: 3, text: "أُنسق مع الفريق التربوي لإعداد مشروع دمج شامل للقسم.", negative: false },
                    { id: 4, text: "أوثق تطور التلميذ وأراجع المشروع البيداغوجي الفردي بانتظام.", negative: false },
                    { id: 5, text: "انطلق في بناء المشروع البيداغوجي الفردي للتلميذ من تحديد أوجه النقص والقصور التي يعاني منها.", negative: true }
                ]
            },
            {
                title: "المحور الثاني: تهيئة البيئة الصفية والدمج الاجتماعي",
                description: "يقيس هذا المحور قدرة الأستاذ على خلق بيئة تعلمية متكاملة تشمل التنظيم المادي المدروس، والولوجيات المكيفة، والوسائل البصرية والسمعية، وإرساء روتين يومي واضح، وتطبيق استراتيجيات إدارة السلوك الإيجابية (البند 6 سالب).",
                startIndex: 6,
                items: [
                    { id: 6, text: "أضع التلميذ ذي الإعاقة الذهنية في مكان منفصل عن المجموعة كي لا يشوش على السير الطبيعي للدروس.", negative: true },
                    { id: 7, text: "أرسي روتيناً يومياً ثابتاً ومرناً يناسب حاجات التلميذ.", negative: false },
                    { id: 8, text: "أُشجع التلميذ بالمكافآت (الثناء، الأوسمة، اللوائح...) عند إنجازه للمهام المطلوبة.", negative: false },
                    { id: 9, text: "أُشرك التلميذ في الأنشطة الجماعية وألعاب التفاعل الاجتماعي داخل القسم.", negative: false },
                    { id: 10, text: "عند ظهور سلوك غير مرغوب أحدد أسبابه وأطبق استراتيجيات إيجابية بديلة لمعالجته.", negative: false },
                    { id: 11, text: "أكلف التلميذ بمهمات منتظمة يكون فيها تحركه مفيداً ووظيفياً، كجمع الدفاتر أو توزيع الأوراق والأدوات على المتعلمين.", negative: false }
                ]
            },
            {
                title: "المحور الثالث: التكييف البيداغوجي والممارسات التدريسية",
                description: "يقيس هذا المحور تطبيق عدد من البيداغوجيات الدامجة: كالبيداغوجيا الفارقية، بيداغوجيا اللعب، وبيداغوجيا الوساطة عبر العمل في مجموعات صغيرة مع أقران داعمين، وتطبيق تفريد التعلمات من خلال تخصيص زمن مرن وتقسيم المهام إلى خطوات متدرجة وربط التعلمات بالخبرات الحياتية (البند 14 سالب).",
                startIndex: 12,
                items: [
                    { id: 12, text: "أقسّم المهام المركبة إلى مهام صغرى، وأبدأ بالأسهل الذي ينجزه التلميذ بنجاح.", negative: false },
                    { id: 13, text: "أربط التعلمات الجديدة بخبرات التلميذ اليومية واهتماماته وسياق محيطه المباشر.", negative: false },
                    { id: 14, text: "أقدم نفس المحتوى التعليمي واتبع نفس الطرق التدريسية مع جميع التلاميذ.", negative: true },
                    { id: 15, text: "أُخصص زمناً مرناً يتناسب مع وتيرة التلميذ وقدرته على التركيز.", negative: false },
                    { id: 16, text: "أستخدم اللعب التعليمي والأنشطة الحس-حركية في تدبير الأنشطة التعليمية.", negative: false },
                    { id: 17, text: "أستعمل كلمات بسيطة عند التوجه للتلميذ بالكلام، مع التأكد من مدى فهمها واستيعابها.", negative: false },
                    { id: 18, text: "أُوفر للتلميذ بدائل متنوعة للتعبير عما تعلمه (شفهي، رسم، حركة، بطاقات).", negative: false }
                ]
            },
            {
                title: "المحور الرابع: التقويم والتحسين المستمر",
                description: "يقيس هذا المحور استخدام أساليب تقويم متنوعة ومكيفة، وربط التقويم بالتحسين المستمر للممارسات، وتوثيق التقدم، ووضع معايير نجاح واضحة، والمرونة في التكييف (البند 22 سالب).",
                startIndex: 19,
                items: [
                    { id: 19, text: "أستخدم أساليب تقويم متنوعة ومكيفة (شفهية، عملية، بصرية) حسب قدرات التلميذ.", negative: false },
                    { id: 20, text: "أقارن أداء التلميذ الحالي بأدائه السابق لرؤية تطوره.", negative: false },
                    { id: 21, text: "أستثمر نتائج التقويم التكويني المستمر في تحسين طرائق التدريس.", negative: false },
                    { id: 22, text: "في الفروض المحروسة، أقدم لجميع التلاميذ اختبارات موحدة.", negative: true }
                ]
            },
            {
                title: "المحور الخامس: الشراكة والعمل التعاوني",
                description: "يقيس هذا المحور بناء شراكة فعّالة ومتكاملة تشمل التواصل المنتظم مع الأسرة، والتعاون مع الفريق متعدد التخصصات، والتنسيق مع قاعة الموارد، والمشاركة في الاجتماعات التربوية (البند 23 سالب).",
                startIndex: 23,
                items: [
                    { id: 23, text: "أجد صعوبة في التواصل مع أسرة التلميذ حول تقدمه في المدرسة.", negative: true },
                    { id: 24, text: "أتعاون مع الفريق المتعدد الاختصاصات (طبي، شبه طبي، نفسي، نطق) لدعم التلميذ في وضعية إعاقة ذهنية.", negative: false },
                    { id: 25, text: "أشارك في الاجتماعات التربوية والمجالس الخاصة بالتربية الدامجة.", negative: false },
                    { id: 26, text: "أُنسق مع أساتذة قاعة الموارد لتنظيم تناوب متوازن بين القسم وقاعة الموارد.", negative: false }
                ]
            },
            {
                title: "المحور السادس: التطوير المهني والممارسة التأملية",
                description: "يقيس هذا المحور التأمل في الممارسات المهنية وتحديد نقاط التحسين، والبحث عن موارد جديدة ومواكبة المستجدات، والمشاركة في التكوينات وتطبيق المكتسبات، وتوثيق الممارسات الناجحة ونشرها. تشمل المؤشرات الدالة حضور التكوينات وتجريب طرق جديدة وتوثيق التجارب والتطوير المستمر (البند 30 سالب).",
                startIndex: 27,
                items: [
                    { id: 27, text: "أفكر في ممارساتي المهنية الدامجة وأحدد ما تحتاج إليه من تطوير.", negative: false },
                    { id: 28, text: "أُشارك في أنشطة التكوين والتدريب المتعلقة بالتربية الدامجة.", negative: false },
                    { id: 29, text: "أتابع المستجدات من المذكرات والدلائل الوزارية في مجال التربية الدامجة.", negative: false },
                    { id: 30, text: "احتفظ بخبرتي في مجال الدمج لنفسي، ولا أشاركها مع الآخرين.", negative: true }
                ]
            }
        ];

        // ===== حساب العدد الكلي ديناميكياً =====
        const TOTAL_ITEMS = AXIS_INFO.reduce((sum, axis) => sum + axis.items.length, 0);

        let currentPage = 0;
        let totalPages = 0;
        let formData = {};
        let lastSaveTime = Date.now();

        // إنشاء صفحات المحاور ديناميكياً
        function createItemPages() {
            const content = document.querySelector('.content');
            const summaryPage = document.getElementById('summary-page');
            
            AXIS_INFO.forEach((axis, axisIndex) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                pageDiv.id = `axis-page-${axisIndex}`;
                
                let pageHTML = `
                    <div class="axis-header">
                        <h3>${axis.title}</h3>
                        <p>${axis.description}</p>
                    </div>
                    
                    <div class="criteria-explanation" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; border-right: 5px solid #17a2b8;">
                        <h4 style="color: #0c5460; margin-bottom: 15px;">🔍 معايير التحكيم:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <div>
                                <strong style="color: #0c5460;">مدى الملاءمة؟</strong>
                                <p style="font-size: 0.9em; margin: 5px 0 0 0;"> هل يقيس البند فعلاً البعد المطلوب من هذا المحور؟ اكتب الرقم المناسب من 5 إلى 1</p>
                                <small>1 = غير ملائم | 5 = ملائم تماماً</small>
                            </div>
                            <div>
                                <strong style="color: #0c5460;">مدى الوضوح؟</strong>
                                <p style="font-size: 0.9em; margin: 5px 0 0 0;"> هل الصياغة واضحة ومفهومة للأستاذ؟ اكتب الرقم المناسب من 5 إلى 1</p>
                                <small>1 = غير واضح | 5 = واضح تماماً</small>
                            </div>
                            <div>
                                <strong style="color: #0c5460;">مدى الضرورة؟</strong>
                                <p style="font-size: 0.9em; margin: 5px 0 0 0;">هل البند ضروري ومهم في هذا المحور؟ اكتب الرقم المناسب من 5 إلى 1</p>
                                <small>1 = غير ضروري | 5 = ضروري جداً</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="evaluation-container">
                        <table class="axis-evaluation-table" style="width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; direction: rtl;">
                            <thead>
                                <tr style="background: #3498db; color: white;">
                                    <th style="padding: 15px; text-align: center; width: 50%;">البند</th>
                                    <th style="padding: 15px; text-align: center; width: 16.67%;">مدى الملاءمة؟</th>
                                    <th style="padding: 15px; text-align: center; width: 16.67%;">مدى الوضوح؟</th>
                                    <th style="padding: 15px; text-align: center; width: 16.67%;">مدى الضرورة؟</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                axis.items.forEach((item, index) => {
                    const itemStyle = item.negative ? 'color: #dc3545; font-weight: bold;' : '';
                    pageHTML += `
                        <tr style="border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                            <td style="padding: 15px; text-align: right; vertical-align: top; ${itemStyle}">
                                <strong>البند ${item.id}:</strong> ${item.text}
                            </td>
                            <td style="padding: 15px; text-align: center; vertical-align: middle;">
                                <input type="number" name="item${item.id}_relevance" min="1" max="5" 
                                       style="width: 60px; padding: 8px; text-align: center; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
                                       placeholder="1-5" required>
                            </td>
                            <td style="padding: 15px; text-align: center; vertical-align: middle;">
                                <input type="number" name="item${item.id}_clarity" min="1" max="5" 
                                       style="width: 60px; padding: 8px; text-align: center; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
                                       placeholder="1-5" required>
                            </td>
                            <td style="padding: 15px; text-align: center; vertical-align: middle;">
                                <input type="number" name="item${item.id}_necessity" min="1" max="5" 
                                       style="width: 60px; padding: 8px; text-align: center; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;"
                                       placeholder="1-5" required>
                            </td>
                        </tr>
                    `;
                });
                
                pageHTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="axis-comments-section" style="margin-top: 30px;">
                        <label style="font-weight: bold; color: #555; margin-bottom: 10px; display: block;">
                            💬 تعليقات أو اقتراحات عامة حول هذا المحور (اختياري):
                        </label>
                        <textarea name="axis${axisIndex + 1}_comment" rows="4" 
                                  style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"
                                  placeholder="أي ملاحظات أو اقتراحات لتحسين هذا المحور أو تعديل أحد البنود..."></textarea>
                    </div>
                    
                    <div class="error-message" id="error-axis-${axisIndex}" style="color: #e74c3c; background: #fdf2f2; padding: 10px; border-radius: 5px; margin-top: 10px; display: none;"></div>
                    
                    <div class="navigation-buttons" style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button class="btn btn-secondary" onclick="prevPage()">السابق</button>
                        <button class="btn" onclick="nextPage()">التالي</button>
                    </div>
                `;
                
                pageDiv.innerHTML = pageHTML;
                content.insertBefore(pageDiv, summaryPage);
            });
            
            totalPages = document.querySelectorAll('.page').length;
        }

        // إزالة setup النجوم واستبداله بالتحقق من الخانات الرقمية
        function setupNumericInputs() {
            document.addEventListener('input', function(e) {
                if (e.target.type === 'number' && (e.target.name.includes('_relevance') || e.target.name.includes('_clarity') || e.target.name.includes('_necessity'))) {
                    const value = parseInt(e.target.value);
                    if (value < 1 || value > 5) {
                        e.target.style.borderColor = '#e74c3c';
                        e.target.style.backgroundColor = '#fff5f5';
                    } else {
                        e.target.style.borderColor = '#ddd';
                        e.target.style.backgroundColor = 'white';
                        formData[e.target.name] = value;
                        saveCurrentPageData();
                    }
                }
            });
        }

        // إدارة الصفحات
        function nextPage() {
            // للصفحة الأولى (الترحيب)، لا نحتاج للتحقق من البيانات
            if (currentPage > 0) {
                if (!validateCurrentPage()) return;
            }
            
            saveCurrentPageData();
            
            if (currentPage < totalPages - 1) {
                document.querySelectorAll('.page')[currentPage].classList.remove('active');
                currentPage++;
                document.querySelectorAll('.page')[currentPage].classList.add('active');
                updateProgress();
                window.scrollTo(0, 0);
                
                if (currentPage === totalPages - 1) {
                    calculateSummary();
                }
            }
        }

        function prevPage() {
            saveCurrentPageData();
            if (currentPage > 0) {
                document.querySelectorAll('.page')[currentPage].classList.remove('active');
                currentPage--;
                document.querySelectorAll('.page')[currentPage].classList.add('active');
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        function updateProgress() {
            const progress = ((currentPage + 1) / totalPages) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `الصفحة ${currentPage + 1} من ${totalPages}`;
        }

        // التحقق من صحة البيانات
        function validateCurrentPage() {
            const currentPageElement = document.querySelectorAll('.page')[currentPage];
            clearErrors();

            let isValid = true;
            let errorMessage = '';

            // الصفحة الأولى (الترحيب) لا تحتاج تحقق
            if (currentPage === 0) {
                return true;
            }
            else if (currentPage === 1) {
                // التحقق من بيانات المحكم
                const requiredFields = ['expert_name', 'expert_role', 'years_experience'];
                for (const fieldName of requiredFields) {
                    const field = currentPageElement.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value.trim()) {
                        field?.classList.add('invalid');
                        isValid = false;
                        errorMessage = 'يرجى ملء جميع الحقول المطلوبة *';
                    }
                }
            } else if (currentPage >= 2 && currentPage < totalPages - 1) {
                // التحقق من تقييمات البنود
                const axisIndex = currentPage - 2;
                const axis = AXIS_INFO[axisIndex];
                
                axis.items.forEach(item => {
                    const relevanceInput = currentPageElement.querySelector(`[name="item${item.id}_relevance"]`);
                    const clarityInput = currentPageElement.querySelector(`[name="item${item.id}_clarity"]`);
                    const necessityInput = currentPageElement.querySelector(`[name="item${item.id}_necessity"]`);
                    
                    [relevanceInput, clarityInput, necessityInput].forEach(input => {
                        if (!input || !input.value || input.value < 1 || input.value > 5) {
                            input?.classList.add('invalid');
                            input.style.borderColor = '#e74c3c';
                            input.style.backgroundColor = '#fff5f5';
                            isValid = false;
                            errorMessage = 'يرجى تقييم جميع البنود من 1 إلى 5 في هذا المحور';
                        }
                    });
                });
            }

            if (!isValid) {
                const errorElement = currentPageElement.querySelector('.error-message');
                if (errorElement) {
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                }
            }
            return isValid;
        }

        function clearErrors() {
            document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        }

        // حفظ البيانات
        function saveCurrentPageData() {
            const currentPageElement = document.querySelectorAll('.page')[currentPage];
            const inputs = currentPageElement.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) formData[input.name] = input.value;
                } else {
                    formData[input.name] = input.value;
                }
            });

            try {
                localStorage.setItem('evaluationFormData', JSON.stringify(formData));
                showSaveStatus('💾 تم الحفظ تلقائياً - يمكنك العودة لاحقاً لإكمال التحكيم');
                lastSaveTime = Date.now();
            } catch (e) {
                console.error('خطأ في الحفظ:', e);
            }
        }

        function showSaveStatus(message) {
            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = message;
            statusElement.classList.add('show');
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 3000);
        }

        // الحفظ التلقائي الذكي
        function smartAutoSave() {
            const timeSinceLastSave = Date.now() - lastSaveTime;
            if (timeSinceLastSave > 30000) { // إذا مر أكثر من 30 ثانية
                saveCurrentPageData();
            }
        }

        // حساب الملخص
        function calculateSummary() {
            let completed = 0;
            let totalRelevance = 0, totalClarity = 0, totalNecessity = 0;
            let lowRatedItems = [];
            let totalPossibleItems = 0;

            // حساب العدد الكلي للبنود
            AXIS_INFO.forEach(axis => {
                totalPossibleItems += axis.items.length;
            });

            AXIS_INFO.forEach(axis => {
                axis.items.forEach(item => {
                    const relevance = Number(formData[`item${item.id}_relevance`]);
                    const clarity = Number(formData[`item${item.id}_clarity`]);
                    const necessity = Number(formData[`item${item.id}_necessity`]);

                    if (Number.isFinite(relevance) && Number.isFinite(clarity) && Number.isFinite(necessity)) {
                        completed++;
                        totalRelevance += relevance;
                        totalClarity += clarity;
                        totalNecessity += necessity;

                        if (relevance < 4 || clarity < 4 || necessity < 4) {
                            lowRatedItems.push({ item: item.id, relevance, clarity, necessity });
                        }
                    }
                });
            });

            document.getElementById('completed-items').textContent = `${completed}/${totalPossibleItems}`;
            document.getElementById('avg-relevance').textContent = completed > 0 ? (totalRelevance / completed).toFixed(1) + '/5' : '0.0/5';
            document.getElementById('avg-clarity').textContent = completed > 0 ? (totalClarity / completed).toFixed(1) + '/5' : '0.0/5';
            document.getElementById('avg-necessity').textContent = completed > 0 ? (totalNecessity / completed).toFixed(1) + '/5' : '0.0/5';

            const lowRatedList = document.getElementById('low-rated-list');
            if (lowRatedItems.length > 0) {
                lowRatedList.innerHTML = lowRatedItems.map(item => 
                    `<p>• البند ${item.item}: الملاءمة (${item.relevance}/5) - الوضوح (${item.clarity}/5) - الضرورة (${item.necessity}/5)</p>`
                ).join('');
            } else {
                lowRatedList.innerHTML = '<p style="color: #27ae60;">🎉 جميع البنود حصلت على تقييم عالٍ!</p>';
            }
        }

        // إرسال النموذج
        async function submitForm() {
            if (!validateCurrentPage()) return;
            saveCurrentPageData();

            if (!confirm('هل أنتم متأكدون من إرسال التحكيم؟ لن تتمكنوا من التعديل بعد الإرسال.')) return;

            try {
                const payload = new URLSearchParams();

                // بيانات المحكم
                payload.append('expert_name', formData.expert_name || '');
                payload.append('expert_role', formData.expert_role === 'أخرى' ? (formData.expert_role_other || '') : (formData.expert_role || ''));
                payload.append('years_experience', formData.years_experience || '');
                payload.append('experience_type', formData.experience_type || '');
                payload.append('email', formData.email || '');

                // بيانات البنود - نستخدم نظام جديد
                AXIS_INFO.forEach(axis => {
                    axis.items.forEach(item => {
                        payload.append(`item${item.id}_relevance`, formData[`item${item.id}_relevance`] || '');
                        payload.append(`item${item.id}_clarity`, formData[`item${item.id}_clarity`] || '');
                        payload.append(`item${item.id}_necessity`, formData[`item${item.id}_necessity`] || '');
                    });
                });

                // التعليقات العامة للمحاور
                AXIS_INFO.forEach((axis, index) => {
                    payload.append(`axis${index + 1}_comment`, formData[`axis${index + 1}_comment`] || '');
                });

                // التعليقات النهائية
                payload.append('missing_items', formData.missing_items || '');
                payload.append('improvement_suggestions', formData.improvement_suggestions || '');

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                    body: payload.toString()
                });

                const serverResponse = await response.text();
                console.log('Server response:', serverResponse);

                if (!response.ok) throw new Error('فشل في الإرسال');

                document.querySelector('.content').innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <div style="font-size: 4em; color: #27ae60; margin-bottom: 20px;">✅</div>
                        <h2 style="color: #27ae60; margin-bottom: 15px;">تم إرسال التحكيم بنجاح!</h2>
                        <p style="color: #555; font-size: 1.1em; line-height: 1.6;">
                            شكراً جزيلاً لمساهمتكم القيمة!<br>
                            تم حفظ تقييمكم وسيساهم في تطوير أداة بحثية عالية الجودة.
                        </p>
                    </div>
                `;

                localStorage.removeItem('evaluationFormData');

            } catch (err) {
                console.error(err);
                alert('حدث خطأ في الإرسال. يرجى المحاولة مرة أخرى.');
            }
        }

        // إعادة تعيين جميع التقييمات
        function resetAllNumericInputs() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (input.name.includes('_relevance') || input.name.includes('_clarity') || input.name.includes('_necessity')) {
                    input.value = '';
                    input.style.borderColor = '#ddd';
                    input.style.backgroundColor = 'white';
                }
            });
            
            // مسح البيانات من formData
            AXIS_INFO.forEach(axis => {
                axis.items.forEach(item => {
                    ['relevance', 'clarity', 'necessity'].forEach(type => {
                        delete formData[`item${item.id}_${type}`];
                    });
                });
            });
        }

        // استرجاع البيانات المحفوظة
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('evaluationFormData');
                if (savedData) {
                    if (confirm('توجد جلسة سابقة محفوظة. هل تريد استئنافها؟')) {
                        formData = JSON.parse(savedData);
                        restoreFormData();
                    } else {
                        localStorage.removeItem('evaluationFormData');
                        formData = {};
                        resetAllNumericInputs();
                    }
                }
            } catch (e) {
                console.error('خطأ في استرجاع البيانات:', e);
            }
        }

        function restoreFormData() {
            // استرجاع البيانات النصية
            for (const [name, val] of Object.entries(formData)) {
                const elements = document.querySelectorAll('[name="' + name + '"]');
                elements.forEach(element => {
                    if (element.type === 'radio') {
                        if (element.value === val) element.checked = true;
                    } else {
                        element.value = val || '';
                    }
                });
            }

            // إظهار حقل "أخرى" إن وُجد
            const roleSelect = document.querySelector('[name="expert_role"]');
            const otherGroup = document.getElementById('other-role-group');
            if (roleSelect && roleSelect.value === 'أخرى' && otherGroup) {
                otherGroup.style.display = 'block';
            }

            // استرجاع التقييمات الرقمية
            AXIS_INFO.forEach(axis => {
                axis.items.forEach(item => {
                    ['relevance', 'clarity', 'necessity'].forEach(type => {
                        const value = formData[`item${item.id}_${type}`];
                        if (value) {
                            const input = document.querySelector(`[name="item${item.id}_${type}"]`);
                            if (input) {
                                input.value = value;
                                input.style.borderColor = '#ddd';
                                input.style.backgroundColor = 'white';
                            }
                        }
                    });
                });
            });
        }

        // أحداث عامة
        function setupEventListeners() {
            // إظهار/إخفاء حقل "أخرى"
            document.addEventListener('change', function(e) {
                if (e.target.name === 'expert_role') {
                    const otherGroup = document.getElementById('other-role-group');
                    if (e.target.value === 'أخرى') {
                        otherGroup.style.display = 'block';
                    } else {
                        otherGroup.style.display = 'none';
                    }
                }
            });

            // حفظ تلقائي كل 30 ثانية
            setInterval(() => {
                if (Object.keys(formData).length > 0) {
                    smartAutoSave();
                }
            }, 30000);

            // حفظ عند مغادرة الصفحة
            window.addEventListener('beforeunload', function(e) {
                saveCurrentPageData();
                if (currentPage > 0 && Object.keys(formData).length > 0) {
                    e.preventDefault();
                    e.returnValue = 'سيتم فقدان البيانات غير المحفوظة. هل تريد المغادرة؟';
                }
            });
        }

        // تهيئة الصفحة
        function initializePage() {
            // حساب العدد الكلي للبنود من البيانات الجديدة
            const totalItems = AXIS_INFO.reduce((sum, axis) => sum + axis.items.length, 0);
            
            // تعبئة أرقام المحاور والبنود في التعليمات الافتتاحية
            const totalAxesSpan = document.getElementById('total-axes-span');
            const totalItemsSpan = document.getElementById('total-items-span');
            if (totalAxesSpan) totalAxesSpan.textContent = AXIS_INFO.length;
            if (totalItemsSpan) totalItemsSpan.textContent = totalItems;

            createItemPages();
            totalPages = document.querySelectorAll('.page').length;
            updateProgress();

            loadSavedData();
            setupEventListeners();
            setupNumericInputs(); // استبدال setupStarRatings بـ setupNumericInputs
            
            // التأكد من أن الدوال متاحة عالمياً
            window.nextPage = nextPage;
            window.prevPage = prevPage;
            window.submitForm = submitForm;
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
