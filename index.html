<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارة تحكيم الممارسات التربوية الدامجة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .page-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .page-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .radio-group label {
            font-weight: normal;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .radio-group label:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .radio-group input[type="radio"] {
            margin-left: 8px;
            margin-right: 5px;
        }

        .radio-group input[type="radio"]:checked + span {
            color: #3498db;
            font-weight: bold;
        }

        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s;
            position: relative;
        }

        .item-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .item-card.invalid {
            border-color: #e74c3c;
            background-color: #fff5f5;
        }

        .item-number {
            position: absolute;
            top: -10px;
            right: 15px;
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .item-text {
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-right: 60px;
            line-height: 1.7;
            font-weight: 500;
        }

        .conditional-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .conditional-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 200px; }
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .error-message {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .invalid {
            border-color: #e74c3c !important;
            background-color: #fff5f5 !important;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-group label:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 8px;
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .radio-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>استمارة تحكيم الممارسات التربوية الدامجة</h1>
            <p>المقياس الميداني لمدى التزام أساتذة التعليم الابتدائي بالممارسات التربوية الدامجة للتلاميذ في وضعية إعاقة ذهنية</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- صفحة الترحيب -->
            <div class="page active" id="page0">
                <div class="page-title">مرحباً بكم في استمارة التحكيم</div>
                
                <div class="page-subtitle">
                    <strong>الغرض من التحكيم:</strong> تقييم جودة أداة قياس مدى التزام أساتذة التعليم الابتدائي بالممارسات التربوية الدامجة وفق المرجعيات المغربية الرسمية.
                </div>

                <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #3498db; margin: 25px 0;">
                    <h3 style="color: #2980b9; margin-bottom: 15px;">المرجعيات المعتمدة:</h3>
                    <ul style="list-style-type: disc; padding-right: 20px; color: #555;">
                        <li>الإطار المرجعي للتربية الدامجة لفائدة الأطفال في وضعية إعاقة – وزارة التربية الوطنية (2019)</li>
                        <li>دليل الأستاذ للتربية الدامجة</li>
                        <li>القرار الوزاري رقم 047.19 بشأن التربية الدامجة للتلميذات والتلاميذ في وضعية إعاقة</li>
                    </ul>
                </div>

                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 25px 0;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">ما المطلوب منكم:</h4>
                    <p>• تقييم 36 بند وفق نهج مبسط وسريع</p>
                    <p>• لكل بند: اختيار (مناسب / يحتاج تعديل / غير مناسب)</p>
                    <p>• الوقت المتوقع: 20-30 دقيقة</p>
                    <p>• يتم الحفظ التلقائي كل 30 ثانية</p>
                </div>

                <div class="navigation-buttons">
                    <div></div>
                    <button class="btn" onclick="nextPage()">البدء في التحكيم</button>
                </div>
            </div>

            <!-- صفحة بيانات المحكم -->
            <div class="page" id="page1">
                <div class="page-title">بيانات المحكم</div>
                <div class="page-subtitle">معلومات عامة تساعد في توثيق عملية التحكيم</div>

                <div class="form-group">
                    <label>اسم المُحكِّم *</label>
                    <input type="text" name="expert_name" placeholder="الاسم الكامل">
                </div>

                <div class="form-group">
                    <label>الصفة/الدور *</label>
                    <select name="expert_role">
                        <option value="">اختر...</option>
                        <option value="عضو هيئة تدريس">عضو هيئة تدريس</option>
                        <option value="باحث">باحث</option>
                        <option value="مشرف أكاديمي">مشرف أكاديمي</option>
                        <option value="خبير ميداني">خبير ميداني</option>
                        <option value="مفتش تربوي">مفتش تربوي</option>
                        <option value="مدير مؤسسة تعليمية">مدير مؤسسة تعليمية</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>سنوات الخبرة *</label>
                    <input type="number" name="years_experience" min="0" max="60" placeholder="عدد السنوات">
                </div>

                <div class="form-group">
                    <label>طبيعة الخبرة بالتربية الدامجة</label>
                    <select name="experience_type">
                        <option value="">اختر...</option>
                        <option value="تدريس">تدريس</option>
                        <option value="بحث">بحث</option>
                        <option value="إدارة/تنفيذ">إدارة/تنفيذ</option>
                        <option value="تدريب معلمين">تدريب معلمين</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>البريد الإلكتروني (اختياري)</label>
                    <input type="email" name="email" placeholder="your@email.com">
                </div>

                <div class="error-message" id="error1"></div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="prevPage()">السابق</button>
                    <button class="btn" onclick="nextPage()">التالي</button>
                </div>
            </div>

            <!-- المحاور ستُضاف هنا ديناميكياً -->

            <!-- صفحة التعليقات النهائية -->
            <div class="page" id="final-page">
                <div class="page-title">تعليقات نهائية</div>

                <div class="form-group">
                    <label>هل توجد بنود مهمة مفقودة تقترحون إضافتها؟</label>
                    <textarea name="missing_items" rows="4" placeholder="اذكروا البنود المهمة التي ترون ضرورة إضافتها..."></textarea>
                </div>

                <div class="form-group">
                    <label>اقتراحات أخرى لتحسين الاستمارة</label>
                    <textarea name="improvement_suggestions" rows="4" placeholder="أي اقتراحات أخرى لتطوير وتحسين الاستمارة..."></textarea>
                </div>

                <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 10px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: #155724; margin-bottom: 10px;">🎉 شكراً جزيلاً لكم!</h4>
                    <p style="color: #155724; margin: 0;">
                        مساهمتكم القيمة ستساعد في تطوير أداة بحثية عالية الجودة تخدم التربية الدامجة في المغرب.
                    </p>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-secondary" onclick="prevPage()">السابق</button>
                    <button class="btn" onclick="submitForm()">إرسال التحكيم النهائي</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // إعدادات أساسية
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1XY-zPav1TPCz6-0ItML-Cx7UXagf1TH1mIpvhPhAjm63txjVlEoVsT8wqxKyzCIhfg/exec';

        // نصوص البنود الـ36
        const ITEMS = [
            "أجري تقويمًا تشخيصيًا أوليًا لتحديد قدرات وحاجيات كل تلميذ في وضعية إعاقة ذهنية قبل بدء التدريس.",
            "أستعمل أدوات متعددة (مقابلات، ملاحظات صفية، اختبارات مبسطة) لجمع معلومات دقيقة حول التلميذ في وضعية إعاقة ذهنية.",
            "أحدد مستوى الأداء الحالي للتلميذ في المجالات الأكاديمية، التواصلية، الاجتماعية، والحركية.",
            "أطلب آراء أو تقارير الأخصائيين (نفسي، نطق، علاج وظيفي) لاستكمال التشخيص.",
            "أُعد تقريرًا تشخيصيًا مكتوبًا يتضمن الحاجات التربوية للتلميذ في وضعية إعاقة ذهنية وأضعه في ملفه المدرسي.",
            "أشارك في إعداد المشروع البيداغوجي الفردي للتلميذ في وضعية إعاقة ذهنية بالتعاون مع الفريق التربوي والأسرة.",
            "أحدد أهدافًا تعليمية واقعية وقابلة للتحقق تراعي إمكانات التلميذ في وضعية إعاقة ذهنية.",
            "أُكيّف محتوى الدروس والأنشطة لتلائم المشروع البيداغوجي الفردي.",
            "أعدل زمن الأنشطة بما يتناسب مع قدرة التلميذ على التركيز والتحمل.",
            "أطبق استراتيجيات تدريس متنوعة (البيداغوجيا الفارقية، العمل التعاوني، الوسائط البصرية والحسية) مع التلميذ في وضعية إعاقة ذهنية.",
            "أبسط اللغة وأفكك المهام المعقدة، من المحسوس إلى المجرد، للتلميذ في وضعية إعاقة ذهنية.",
            "أتابع مدى تحقق الأهداف في المشروع البيداغوجي الفردي وأُحدّث الخطة عند الحاجة.",
            "أدمج التلميذ في وضعية إعاقة ذهنية في أنشطة جماعية منذ الحصص الأولى لتعزيز انتمائه.",
            "أوفّر بيئة صفية آمنة نفسيًا واجتماعيًا تحفز المشاركة والمبادرة.",
            "أوفر فرصًا منتظمة للتفاعل والتعاون بين التلميذ في وضعية إعاقة ذهنية وزملائه.",
            "أطبق أساليب وقائية لتعزيز السلوك الإيجابي وتقليل السلوكيات الصعبة لدى التلميذ في وضعية إعاقة ذهنية.",
            "أمنح التلميذ في وضعية إعاقة ذهنية أدوارًا ومسؤوليات مناسبة لقدراته.",
            "أحتفي بإنجازات التلميذ في وضعية إعاقة ذهنية وأعرضها كنماذج إيجابية لزملائه.",
            "أنظم فضاء القسم بما ييسر الحركة والوصول الآمن للتلميذ في وضعية إعاقة ذهنية.",
            "أستفيد من قاعة الموارد لتقديم دعم فردي أو جماعي للتلميذ في وضعية إعاقة ذهنية.",
            "أنظم التناوب بين زمن القسم وزمن قاعة الموارد لضمان التكامل.",
            "أنمي الإيقاظ الذهني والانتباه والتركيز لدى التلميذ في وضعية إعاقة ذهنية من خلال أنشطة موجهة.",
            "أنمي المهارات الحركية الدقيقة لدى التلميذ في وضعية إعاقة ذهنية من خلال أنشطة عملية.",
            "أطور الإدراك البصري والتمييز البصري-المكاني لدى التلميذ في وضعية إعاقة ذهنية عبر تدريبات موجهة.",
            "أنمي مهارات التواصل لدى التلميذ في وضعية إعاقة ذهنية عبر أنشطة جماعية أو لعب موجه.",
            "أدرّب التلميذ في وضعية إعاقة ذهنية على مهارات حياتية أساسية تعزز استقلاليته.",
            "أُكيّف أدوات التقييم (شفوي، عملي، رقمي) لتناسب احتياجات التلميذ في وضعية إعاقة ذهنية.",
            "أطبق تكييفات الامتحانات مثل إعطاء وقت إضافي أو قراءة الأسئلة شفويًا.",
            "أقيم تقدم التلميذ بناءً على أهدافه الفردية وليس بالمقارنة مع أقرانه.",
            "أستخدم التقويم التكويني المستمر لتعديل طرائق التدريس للتلميذ في وضعية إعاقة ذهنية.",
            "أجري تقويمات مرحلية دورية لتحديث المشروع البيداغوجي الفردي للتلميذ في وضعية إعاقة ذهنية.",
            "أوثق تقدم التلميذ في وضعية إعاقة ذهنية في ملف خاص يضم نتائج التقويم والملاحظات.",
            "أشارك نتائج المتابعة مع الأسرة والفريق التربوي والطبي.",
            "أستخدم سجلات زمنية لرصد إنجاز التلميذ في وضعية إعاقة ذهنية بالنسبة للأهداف المحددة.",
            "أقدم مقترحات مكتوبة لتعديل الأهداف أو إحالة التلميذ على خدمات دعم إضافية.",
            "أسجل في تقارير دورية أثر التعديلات على أداء التلميذ في وضعية إعاقة ذهنية."
        ];

        let currentPage = 0;
        let totalPages = 0;
        let formData = {};

        // إنشاء صفحات البنود ديناميكياً
        function createItemPages() {
            const content = document.querySelector('.content');
            const finalPage = document.getElementById('final-page');
            
            // إنشاء صفحات البنود (6 بنود لكل صفحة)
            const itemsPerPage = 6;
            const pageCount = Math.ceil(ITEMS.length / itemsPerPage);
            
            for (let pageIndex = 0; pageIndex < pageCount; pageIndex++) {
                const startIndex = pageIndex * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, ITEMS.length);
                
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page';
                pageDiv.id = `page${pageIndex + 2}`;
                
                const pageTitle = `البنود ${startIndex + 1} - ${endIndex}`;
                
                let pageHTML = `
                    <div class="page-title">${pageTitle}</div>
                    <div class="page-subtitle">
                        يرجى تقييم كل بند بحسب مناسبته للاستمارة
                    </div>
                `;
                
                for (let i = startIndex; i < endIndex; i++) {
                    const itemNumber = i + 1;
                    const itemText = ITEMS[i];
                    
                    pageHTML += `
                        <div class="item-card">
                            <div class="item-number">البند ${itemNumber} من 36</div>
                            <div class="item-text">${itemText}</div>
                            
                            <div class="form-group">
                                <label>تقييمك لهذا البند: *</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="item${itemNumber}_evaluation" value="مناسب" onchange="handleItemEvaluation(${itemNumber}, 'مناسب')">
                                        <span>مناسب</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="item${itemNumber}_evaluation" value="يحتاج تعديل" onchange="handleItemEvaluation(${itemNumber}, 'يحتاج تعديل')">
                                        <span>يحتاج تعديل</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="item${itemNumber}_evaluation" value="غير مناسب" onchange="handleItemEvaluation(${itemNumber}, 'غير مناسب')">
                                        <span>غير مناسب</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="conditional-section" id="edit-section-${itemNumber}">
                                <label>التعديل المقترح: *</label>
                                <textarea name="item${itemNumber}_edit_suggestion" rows="3" placeholder="اقترح التعديل المطلوب..."></textarea>
                            </div>
                            
                            <div class="conditional-section" id="reject-section-${itemNumber}">
                                <label>سبب عدم المناسبة: *</label>
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" name="item${itemNumber}_reject_reason" value="غامض/غير واضح">
                                        <span>غامض/غير واضح</span>
                                    </label>
                                    <label>
                                        <input type="checkbox" name="item${itemNumber}_reject_reason" value="غير مهم/غير مرتبط">
                                        <span>غير مهم/غير مرتبط</span>
                                    </label>
                                    <label>
                                        <input type="checkbox" name="item${itemNumber}_reject_reason" value="مكرر مع بند آخر">
                                        <span>مكرر مع بند آخر</span>
                                    </label>
                                    <label>
                                        <input type="checkbox" name="item${itemNumber}_reject_reason" value="غير قابل للتطبيق">
                                        <span>غير قابل للتطبيق</span>
                                    </label>
                                    <label>
                                        <input type="checkbox" name="item${itemNumber}_reject_reason" value="أخرى">
                                        <span>أخرى</span>
                                    </label>
                                </div>
                                <textarea name="item${itemNumber}_reject_other" rows="2" placeholder="أسباب أخرى..." style="margin-top: 10px;"></textarea>
                            </div>
                        </div>
                    `;
                }
                
                pageHTML += `
                    <div class="error-message" id="error${pageIndex + 2}"></div>
                    <div class="navigation-buttons">
                        <button class="btn btn-secondary" onclick="prevPage()">السابق</button>
                        <button class="btn" onclick="nextPage()">التالي</button>
                    </div>
                `;
                
                pageDiv.innerHTML = pageHTML;
                content.insertBefore(pageDiv, finalPage);
            }
            
            // تحديث العدد الإجمالي للصفحات
            totalPages = document.querySelectorAll('.page').length;
        }

        // التعامل مع التقييم التدريجي
        function handleItemEvaluation(itemNumber, value) {
            const editSection = document.getElementById(`edit-section-${itemNumber}`);
            const rejectSection = document.getElementById(`reject-section-${itemNumber}`);
            
            // إخفاء جميع الأقسام أولاً
            editSection.classList.remove('show');
            rejectSection.classList.remove('show');
            
            // إظهار القسم المناسب
            if (value === 'يحتاج تعديل') {
                editSection.classList.add('show');
            } else if (value === 'غير مناسب') {
                rejectSection.classList.add('show');
            }
            
            // حفظ البيانات
            saveCurrentPageData();
        }

        // التنقل بين الصفحات
        function nextPage() {
            if (!validateCurrentPage()) {
                return;
            }
            
            saveCurrentPageData();
            
            if (currentPage < totalPages - 1) {
                document.querySelectorAll('.page')[currentPage].classList.remove('active');
                currentPage++;
                document.querySelectorAll('.page')[currentPage].classList.add('active');
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        function prevPage() {
            saveCurrentPageData();
            
            if (currentPage > 0) {
                document.querySelectorAll('.page')[currentPage].classList.remove('active');
                currentPage--;
                document.querySelectorAll('.page')[currentPage].classList.add('active');
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        // تحديث شريط التقدم
        function updateProgress() {
            const progress = ((currentPage + 1) / totalPages) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // التحقق من صحة البيانات في الصفحة الحالية
        function validateCurrentPage() {
            const currentPageElement = document.querySelectorAll('.page')[currentPage];
            const errorElement = currentPageElement.querySelector('.error-message');
            
            // إزالة الأخطاء السابقة
            clearErrors();
            
            let isValid = true;
            let errorMessage = '';
            
            if (currentPage === 1) {
                // التحقق من بيانات المحكم
                const requiredFields = ['expert_name', 'expert_role', 'years_experience'];
                
                for (const fieldName of requiredFields) {
                    const field = currentPageElement.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value.trim()) {
                        field?.classList.add('invalid');
                        isValid = false;
                        errorMessage = 'يرجى ملء جميع الحقول المطلوبة *';
                    }
                }
            } else if (currentPage >= 2 && currentPage < totalPages - 1) {
                // التحقق من تقييم البنود
                const itemCards = currentPageElement.querySelectorAll('.item-card');
                
                itemCards.forEach((card, index) => {
                    const itemNumber = ((currentPage - 2) * 6) + index + 1;
                    const evaluationRadios = card.querySelectorAll(`input[name="item${itemNumber}_evaluation"]`);
                    const isEvaluated = Array.from(evaluationRadios).some(radio => radio.checked);
                    
                    if (!isEvaluated) {
                        card.classList.add('invalid');
                        isValid = false;
                        errorMessage = 'يرجى تقييم جميع البنود في هذه الصفحة';
                    } else {
                        // التحقق من الحقول الشرطية
                        const evaluationValue = card.querySelector(`input[name="item${itemNumber}_evaluation"]:checked`)?.value;
                        
                        if (evaluationValue === 'يحتاج تعديل') {
                            const editTextarea = card.querySelector(`textarea[name="item${itemNumber}_edit_suggestion"]`);
                            if (!editTextarea?.value.trim()) {
                                editTextarea?.classList.add('invalid');
                                isValid = false;
                                errorMessage = 'يرجى كتابة التعديل المقترح للبنود التي تحتاج تعديل';
                            }
                        } else if (evaluationValue === 'غير مناسب') {
                            const rejectCheckboxes = card.querySelectorAll(`input[name="item${itemNumber}_reject_reason"]`);
                            const isReasonSelected = Array.from(rejectCheckboxes).some(checkbox => checkbox.checked);
                            
                            if (!isReasonSelected) {
                                card.querySelector('.checkbox-group')?.classList.add('invalid');
                                isValid = false;
                                errorMessage = 'يرجى تحديد سبب عدم مناسبة البند';
                            }
                        }
                    }
                });
            }
            
            if (!isValid && errorElement) {
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
            }
            
            return isValid;
        }

        // إزالة أخطاء التحقق
        function clearErrors() {
            document.querySelectorAll('.invalid').forEach(element => {
                element.classList.remove('invalid');
            });
            document.querySelectorAll('.error-message').forEach(element => {
                element.style.display = 'none';
            });
        }

        // حفظ بيانات الصفحة الحالية
        function saveCurrentPageData() {
            const currentPageElement = document.querySelectorAll('.page')[currentPage];
            const inputs = currentPageElement.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) {
                        formData[input.name] = input.value;
                    }
                } else if (input.type === 'checkbox') {
                    if (!formData[input.name]) {
                        formData[input.name] = [];
                    }
                    if (input.checked && !formData[input.name].includes(input.value)) {
                        formData[input.name].push(input.value);
                    } else if (!input.checked) {
                        formData[input.name] = formData[input.name].filter(val => val !== input.value);
                    }
                } else {
                    formData[input.name] = input.value;
                }
            });
            
            // حفظ في التخزين المحلي
            try {
                localStorage.setItem('evaluationFormData', JSON.stringify(formData));
            } catch (e) {
                console.log('Could not save to localStorage');
            }
        }

        // تحميل البيانات المحفوظة
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('evaluationFormData');
                if (savedData) {
                    formData = JSON.parse(savedData);
                    restoreFormData();
                }
            } catch (e) {
                console.log('Could not load from localStorage');
            }
        }

        // استعادة البيانات في النموذج
        function restoreFormData() {
            Object.keys(formData).forEach(name => {
                const elements = document.querySelectorAll(`[name="${name}"]`);
                elements.forEach(element => {
                    if (element.type === 'radio') {
                        if (element.value === formData[name]) {
                            element.checked = true;
                            // تحديث الأقسام الشرطية
                            if (name.includes('_evaluation')) {
                                const itemNumber = name.match(/item(\d+)_evaluation/)?.[1];
                                if (itemNumber) {
                                    handleItemEvaluation(parseInt(itemNumber), element.value);
                                }
                            }
                        }
                    } else if (element.type === 'checkbox') {
                        if (Array.isArray(formData[name]) && formData[name].includes(element.value)) {
                            element.checked = true;
                        }
                    } else {
                        element.value = formData[name] || '';
                    }
                });
            });
        }

        // الحفظ التلقائي
        function setupAutoSave() {
            setInterval(() => {
                saveCurrentPageData();
            }, 30000); // كل 30 ثانية
        }

        // إرسال النموذج النهائي
        async function submitForm() {
            if (!validateCurrentPage()) {
                return;
            }
            
            saveCurrentPageData();
            
            // تأكيد الإرسال
            if (!confirm('هل أنتم متأكدون من إرسال التحكيم؟ لن تتمكنوا من التعديل بعد الإرسال.')) {
                return;
            }
            
            try {
                // تحضير البيانات للإرسال
                const formDataToSend = new FormData();
                
                // إضافة الطابع الزمني
                formDataToSend.append('timestamp', new Date().toISOString());
                
                // إضافة بيانات المحكم
                formDataToSend.append('اسم المُحكِّم', formData.expert_name || '');
                formDataToSend.append('الصفة/الدور', formData.expert_role || '');
                formDataToSend.append('سنوات الخبرة', formData.years_experience || '');
                formDataToSend.append('طبيعة الخبرة بالتربية الدامجة', formData.experience_type || '');
                formDataToSend.append('البريد الإلكتروني', formData.email || '');
                
                // إضافة بيانات البنود
                for (let i = 1; i <= 36; i++) {
                    formDataToSend.append(`البند ${i} - تقييم`, formData[`item${i}_evaluation`] || '');
                    formDataToSend.append(`البند ${i} - تعديل مقترح`, formData[`item${i}_edit_suggestion`] || '');
                    
                    // أسباب الرفض (تحويل المصفوفة إلى نص)
                    const rejectReasons = formData[`item${i}_reject_reason`];
                    if (Array.isArray(rejectReasons)) {
                        formDataToSend.append(`البند ${i} - سبب الرفض`, rejectReasons.join(', '));
                    } else {
                        formDataToSend.append(`البند ${i} - سبب الرفض`, '');
                    }
                }
                
                // إضافة التعليقات النهائية
                formDataToSend.append('بنود مفقودة مقترحة', formData.missing_items || '');
                formDataToSend.append('اقتراحات تحسين الاستمارة', formData.improvement_suggestions || '');
                
                // إرسال البيانات
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formDataToSend
                });
                
                if (response.ok) {
                    // عرض رسالة النجاح
                    document.querySelector('.content').innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <div style="font-size: 4em; color: #27ae60; margin-bottom: 20px;">✅</div>
                            <h2 style="color: #27ae60; margin-bottom: 15px;">تم إرسال التحكيم بنجاح!</h2>
                            <p style="color: #555; font-size: 1.1em; line-height: 1.6;">
                                شكراً جزيلاً لمساهمتكم القيمة!<br>
                                تم حفظ تقييمكم وسيساهم في تطوير أداة بحثية عالية الجودة.
                            </p>
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin: 20px 0;">
                                <p style="color: #1976d2; margin: 0;">
                                    <strong>💡 ملاحظة:</strong> يمكنكم إغلاق هذه النافذة الآن.
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // حذف البيانات المحفوظة
                    localStorage.removeItem('evaluationFormData');
                } else {
                    throw new Error('فشل في الإرسال');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('حدث خطأ في الإرسال. يرجى المحاولة مرة أخرى أو التواصل مع الباحث.');
            }
        }

        // تهيئة الصفحة
        function initializePage() {
            createItemPages();
            updateProgress();
            loadSavedData();
            setupAutoSave();
            
            // إضافة مستمع لحفظ البيانات عند مغادرة الصفحة
            window.addEventListener('beforeunload', function() {
                saveCurrentPageData();
            });
            
            // تحذير من فقدان البيانات
            window.addEventListener('beforeunload', function(e) {
                if (currentPage > 0 && Object.keys(formData).length > 0) {
                    e.preventDefault();
                    e.returnValue = 'سيتم فقدان البيانات غير المحفوظة. هل تريد المغادرة؟';
                }
            });
        }

        // تشغيل التهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
