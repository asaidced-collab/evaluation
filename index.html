<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>استمارة التحكيم – النسخة الكاملة</title>
  <style>
    body { font-family: system-ui,"Segoe UI",Tahoma,Arial; line-height:1.7; margin:0; background:#fafafa; color:#222; }
    .container { max-width:1000px; margin:24px auto; background:#fff; padding:24px; border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.06); }
    h1,h2 { margin-top:0; }
    .page { display:none; }
    .page.active { display:block; }
    .navigation-buttons { display:flex; gap:12px; margin-top:20px; }
    .btn { padding:10px 16px; border:none; border-radius:10px; cursor:pointer; background:#1a73e8; color:#fff; font-weight:600; }
    .btn-secondary { background:#737373; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .progress { background:#eee; height:10px; border-radius:999px; overflow:hidden; margin:16px 0 24px; }
    .progress > span { display:block; height:100%; width:0%; background:#1a73e8; transition:width .3s; }
    .field { margin:12px 0; }
    label { display:block; margin-bottom:6px; font-weight:600; }
    input[type="text"],input[type="number"],input[type="email"],textarea,select { width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; }
    .hint { color:#666; font-size:.9em; }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; }
    .grid .field:nth-child(4) { grid-column: span 3; }
    .item-block hr { border:none; border-top:1px dashed #ddd; margin:16px 0; }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .grid .field:nth-child(4) { grid-column: span 1; }
    }

    /* إبراز الحقول الناقصة */
    .field.invalid { border:1px solid #e11d48 !important; background:#fff1f2; padding:10px; border-radius:10px; }
    .field.invalid label::after { content:" * مطلوب"; color:#e11d48; margin-right:6px; font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <h1>استمارة التحكيم – النسخة الكاملة</h1>
    <div class="progress"><span id="progressFill"></span></div>

    <div id="pages">
      <!-- الصفحة 0: ترحيب -->
      <section class="page active" id="page0">
        <h2>مرحبًا بك</h2>
        <p>هذه النسخة الكاملة من استمارة التحكيم. اضغط الزر لبدء الإدخال.</p>
        <div class="navigation-buttons">
          <button class="btn" type="button" onclick="nextPage()">بدء التحكيم</button>
        </div>
      </section>

      <!-- الصفحة 1: بيانات عامة -->
      <section class="page" id="page1">
        <h2>بيانات المحكّم</h2>
        <div class="grid">
          <div class="field">
            <label>اسم المُحكِّم</label>
            <input type="text" name="اسم المُحكِّم" placeholder="مثال: د. أحمد" />
          </div>
          <div class="field">
            <label>الصفة/الدور</label>
            <select name="الصفة/الدور">
              <option value="">اختر...</option>
              <option value="عضو هيئة تدريس">عضو هيئة تدريس</option>
              <option value="باحث">باحث</option>
              <option value="مشرف أكاديمي">مشرف أكاديمي</option>
              <option value="خبير ميداني">خبير ميداني</option>
            </select>
          </div>
          <div class="field">
            <label>سنوات الخبرة</label>
            <input type="number" name="سنوات الخبرة" min="0" max="60" placeholder="عدد السنوات" />
          </div>
          <div class="field">
            <label>طبيعة الخبرة بالتربية الدامجة</label>
            <select name="طبيعة الخبرة بالتربية الدامجة">
              <option value="">اختر...</option>
              <option value="تدريس">تدريس</option>
              <option value="بحث">بحث</option>
              <option value="إدارة/تنفيذ">إدارة/تنفيذ</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
          <div class="field">
            <label>البريد الإلكتروني (اختياري)</label>
            <input type="email" name="البريد الإلكتروني" />
          </div>
        </div>

        <div class="navigation-buttons">
          <button class="btn btn-secondary" type="button" onclick="prevPage()">السابق</button>
          <button class="btn" type="button" onclick="nextPage()">التالي</button>
        </div>
      </section>
      <!-- الصفحات البنودية ستُولَّد برمجيًا -->
    </div>

    <!-- صفحة التعليقات العامة والتقييم -->
    <section class="page" id="page999">
      <h2>تعليقات عامة وتقييم نهائي</h2>
      <div class="grid">
        <div class="field">
          <label>تعليقات المحور 1</label>
          <textarea name="تعليقات المحور 1" rows="3"></textarea>
        </div>
        <div class="field">
          <label>تعليقات المحور 3</label>
          <textarea name="تعليقات المحور 3" rows="3"></textarea>
        </div>
        <div class="field">
          <label>تعليقات المحور 4</label>
          <textarea name="تعليقات المحور 4" rows="3"></textarea>
        </div>
        <div class="field">
          <label>تعليقات المحور 5</label>
          <textarea name="تعليقات المحور 5" rows="3"></textarea>
        </div>
        <div class="field">
          <label>تعليقات المحور 6</label>
          <textarea name="تعليقات المحور 6" rows="3"></textarea>
        </div>

        <div class="field">
          <label>التقييم الكلي</label>
          <select name="التقييم الكلي">
            <option value="">اختر...</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="field">
          <label>شمول التغطية</label>
          <select name="شمول التغطية">
            <option value="">اختر...</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="field">
          <label>ملاءمة عدد البنود</label>
          <select name="ملاءمة عدد البنود">
            <option value="">اختر...</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="field">
          <label>التوصية النهائية</label>
          <select name="التوصية النهائية">
            <option value="">اختر...</option>
            <option value="نعم">نعم</option>
            <option value="بعد تعديلات">بعد تعديلات</option>
            <option value="لا">لا</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>عناصر القوة</label>
          <textarea name="عناصر القوة" rows="3"></textarea>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>مجالات التحسين</label>
          <textarea name="مجالات التحسين" rows="3"></textarea>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>ملاحظات عامة</label>
          <textarea name="ملاحظات عامة" rows="3"></textarea>
        </div>
      </div>

      <div class="navigation-buttons">
        <button class="btn btn-secondary" type="button" onclick="prevPage()">السابق</button>
        <button class="btn" type="button" onclick="nextPage()">التالي</button>
      </div>
    </section>

    <!-- صفحة الإرسال -->
    <section class="page" id="page1000">
      <h2>إرسال التحكيم</h2>
      <p class="hint">عند الضغط على "إرسال التحكيم" سيتم إرسال جميع البيانات إلى Google Sheet.</p>
      <div class="navigation-buttons">
        <button class="btn btn-secondary" type="button" onclick="prevPage()">السابق</button>
        <button class="btn" type="button" onclick="submitForm()">إرسال التحكيم</button>
      </div>
    </section>

  </div>

  <script>
    // ========= إعدادات =========
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCQrG9O7EeWSqtjNludnMP8rukeeKqqVSY8aAKZRb_ZfuaSTc_LDWlDspGniPOQvN1zA/exec';

    // نستخدم البنود 1–6 ثم 13–36 (مطابق لنسختك الأصلية). إن أردت 7–12 أضفها لاحقًا.
    const ITEM_NUMBERS = [1,2,3,4,5,6, 13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36];

    // ========= إنشاء صفحات البنود ديناميكيًا (6 بنود في الصفحة) =========
    function createItemBlock(n) {
      return `
        <div class="item-block">
          <h3>البند ${n}</h3>
          <p class="hint"><em>ضع نص البند هنا لو رغبت (اختياري)</em></p>

          <div class="grid">
            <div class="field">
              <label>البند ${n} – وضوح</label>
              <div>
                ${[1,2,3,4,5].map(i => `<label><input type="radio" name="البند ${n} – وضوح" value="${i}"> ${i}</label>`).join(' ')}
              </div>
            </div>

            <div class="field">
              <label>البند ${n} – ملاءمة</label>
              <div>
                ${[1,2,3,4,5].map(i => `<label><input type="radio" name="البند ${n} – ملاءمة" value="${i}"> ${i}</label>`).join(' ')}
              </div>
            </div>

            <div class="field">
              <label>البند ${n} – شمولية</label>
              <div>
                ${[1,2,3,4,5].map(i => `<label><input type="radio" name="البند ${n} – شمولية" value="${i}"> ${i}</label>`).join(' ')}
              </div>
            </div>

            <div class="field">
              <label>البند ${n} – قرار</label>
              <div>
                <label><input type="radio" name="البند ${n} – قرار" value="مناسب"> مناسب</label>
                <label><input type="radio" name="البند ${n} – قرار" value="يحتاج تعديل"> يحتاج تعديل</label>
                <label><input type="radio" name="البند ${n} – قرار" value="غير مناسب"> غير مناسب</label>
              </div>
            </div>
          </div>

          <div class="field">
            <label>البند ${n} – ملاحظات</label>
            <textarea name="البند ${n} – ملاحظات" rows="3" placeholder="ملاحظات مختصرة"></textarea>
          </div>

          <hr />
        </div>
      `;
    }

    function createItemPages() {
      const chunkSize = 6;
      const pagesWrap = document.getElementById('pages');
      let pageIndex = 2; // لدينا page0, page1 مسبقًا

      for (let i = 0; i < ITEM_NUMBERS.length; i += chunkSize) {
        const chunk = ITEM_NUMBERS.slice(i, i + chunkSize);
        const blocks = chunk.map(n => createItemBlock(n)).join('');
        const sec = document.createElement('section');
        sec.className = 'page';
        sec.id = 'page' + pageIndex;
        sec.innerHTML = `
          <h2>محاور البنود (${chunk[0]}–${chunk[chunk.length - 1]})</h2>
          ${blocks}
          <div class="navigation-buttons">
            <button class="btn btn-secondary" type="button" onclick="prevPage()">السابق</button>
            <button class="btn" type="button" onclick="nextPage()">التالي</button>
          </div>
        `;
        pagesWrap.appendChild(sec);
        pageIndex++;
      }
    }

    // ========= حالة ونقل الصفحات =========
    window.formData = {};
    let pages = [];
    let currentPage = 0;

    function refreshPages() {
      pages = Array.from(document.querySelectorAll('.page'));
      updateProgress();
    }

    function updateProgress() {
      const fill = document.getElementById('progressFill');
      const progress = ((currentPage + 1) / pages.length) * 100;
      fill.style.width = progress + '%';
    }

    function goTo(i) {
      if (i < 0 || i >= pages.length) return;
      pages[currentPage].classList.remove('active');
      currentPage = i;
      pages[currentPage].classList.add('active');
      updateProgress();
      window.scrollTo(0,0);
    }

    function nextPage() { saveCurrentPageData(); goTo(currentPage + 1); }
    function prevPage() { saveCurrentPageData(); goTo(currentPage - 1); }

    // ========= حفظ بيانات الصفحة الحالية =========
    function saveCurrentPageData() {
      const el = pages[currentPage];
      const inputs = el.querySelectorAll('input, textarea, select');
      const pageData = {};

      inputs.forEach(input => {
        const name = input.name;
        if (!name) return;
        const type = (input.type || '').toLowerCase();
        if (type === 'checkbox') {
          if (!pageData[name]) pageData[name] = [];
          if (input.checked) pageData[name].push(input.value);
        } else if (type === 'radio') {
          if (input.checked) pageData[name] = input.value;
        } else {
          pageData[name] = input.value || '';
        }
      });

      Object.assign(window.formData, pageData);
      try { localStorage.setItem('evaluationFormData', JSON.stringify(window.formData)); } catch(e) {}
    }

    // ========= Helpers لفحص الحقول وإظهار الأخطاء =========
    function clearInvalids() {
      document.querySelectorAll('.field.invalid').forEach(el => el.classList.remove('invalid'));
    }

    function markInvalidFieldByInput(inputEl) {
      const field = inputEl?.closest('.field') || inputEl?.parentElement;
      if (field) field.classList.add('invalid');
      return field;
    }

    function markInvalidRadioGroupByName(name) {
      const radios = document.querySelectorAll(`input[type="radio"][name="${name}"]`);
      if (!radios.length) return null;
      const anyChecked = Array.from(radios).some(r => r.checked);
      if (anyChecked) return null;
      const field = radios[0].closest('.field') || radios[0].parentElement;
      if (field) field.classList.add('invalid');
      return field;
    }

    function pageIndexOfElement(el) {
      const sec = el?.closest('.page');
      return sec ? pages.indexOf(sec) : -1;
    }

    // ========= التحقّق الرئيسي قبل الإرسال =========
    function validateForm() {
      clearInvalids();
      let firstInvalidField = null;
      let firstInvalidPageIdx = -1;

      // الحقول الأساسية
      const requiredSingles = [
        'اسم المُحكِّم',
        'الصفة/الدور',
        'سنوات الخبرة',
        'التوصية النهائية'
      ];

      for (const name of requiredSingles) {
        const el = document.querySelector(`[name="${name}"]`);
        if (!el) continue;
        let ok = true;

        if (el.tagName === 'SELECT' || el.type === 'text' || el.type === 'email' || el.type === 'number') {
          const val = (el.value || '').trim();
          ok = val !== '';
          if (name === 'سنوات الخبرة') {
            const n = Number(val);
            ok = ok && !Number.isNaN(n) && n >= 0 && n <= 60;
          }
        }

        if (!ok) {
          const field = markInvalidFieldByInput(el);
          if (!firstInvalidField) {
            firstInvalidField = field || el;
            firstInvalidPageIdx = pageIndexOfElement(firstInvalidField);
          }
        }
      }

      // قرار لكل بند (ITEM_NUMBERS)
      for (const n of ITEM_NUMBERS) {
        const field = markInvalidRadioGroupByName(`البند ${n} – قرار`);
        if (field && !firstInvalidField) {
          firstInvalidField = field;
          firstInvalidPageIdx = pageIndexOfElement(field);
        }
      }

      // لو يوجد نقص، ننتقل لأول صفحة فيها خطأ
      if (firstInvalidField) {
        if (firstInvalidPageIdx >= 0 && firstInvalidPageIdx !== currentPage) {
          goTo(firstInvalidPageIdx);
          setTimeout(() => firstInvalidField.scrollIntoView({behavior:'smooth', block:'center'}), 200);
        } else {
          firstInvalidField.scrollIntoView({behavior:'smooth', block:'center'});
        }
        alert('رجاءً استكمل الحقول المطلوبة المعلّمة بالأحمر.');
        return false;
      }
      return true;
    }

    // ========= إرسال إلى Google Apps Script (مع التحقّق) =========
    async function submitForm() {
      saveCurrentPageData();

      if (!validateForm()) {
        return; // لا نرسل إذا كانت هناك أخطاء
      }

      const params = new URLSearchParams();
      for (const [k, v] of Object.entries(window.formData)) {
        if (Array.isArray(v)) params.append(k, v.join('; '));
        else params.append(k, v ?? '');
      }
      try {
        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: params.toString(),
          mode: 'no-cors'
        });
        alert('تم إرسال النموذج ✔');
      } catch (e) {
        console.error(e);
        alert('تعذّر الإرسال. تأكد من إعداد Web App.');
      }
    }

    // ========= تهيئة =========
    function createItemPages() {
      const chunkSize = 6;
      const pagesWrap = document.getElementById('pages');
      let pageIndex = 2; // لدينا page0, page1 مسبقًا

      for (let i = 0; i < ITEM_NUMBERS.length; i += chunkSize) {
        const chunk = ITEM_NUMBERS.slice(i, i + chunkSize);
        const blocks = chunk.map(n => createItemBlock(n)).join('');
        const sec = document.createElement('section');
        sec.className = 'page';
        sec.id = 'page' + pageIndex;
        sec.innerHTML = `
          <h2>محاور البنود (${chunk[0]}–${chunk[chunk.length - 1]})</h2>
          ${blocks}
          <div class="navigation-buttons">
            <button class="btn btn-secondary" type="button" onclick="prevPage()">السابق</button>
            <button class="btn" type="button" onclick="nextPage()">التالي</button>
          </div>
        `;
        pagesWrap.appendChild(sec);
        pageIndex++;
      }
    }

    function createItemBlock(n) {
      return `
        <div class="item-block">
          <h3>البند ${n}</h3>
          <p class="hint"><em>ضع نص البند هنا لو رغبت (اختياري)</em></p>

          <div class="grid">
            <div class="field">
              <label>البند ${n} – وضوح</label>
              <div>
                ${[1,2,3,4,5].map(i => `<label><input type="radio" name="البند ${n} – وضوح" value="${i}"> ${i}</label>`).join(' ')}
              </div>
            </div>

            <div class="field">
              <label>البند ${n} – ملاءمة</label>
              <div>
                ${[1,2,3,4,5].map(i => `<label><input type="radio" name="البند ${n} – ملاءمة" value="${i}"> ${i}</label>`).join(' ')}
              </div>
            </div>

            <div class="field">
              <label>البند ${n} – شمولية</label>
              <div>
                ${[1,2,3,4,5].map(i => `<label><input type="radio" name="البند ${n} – شمولية" value="${i}"> ${i}</label>`).join(' ')}
              </div>
            </div>

            <div class="field">
              <label>البند ${n} – قرار</label>
              <div>
                <label><input type="radio" name="البند ${n} – قرار" value="مناسب"> مناسب</label>
                <label><input type="radio" name="البند ${n} – قرار" value="يحتاج تعديل"> يحتاج تعديل</label>
                <label><input type="radio" name="البند ${n} – قرار" value="غير مناسب"> غير مناسب</label>
              </div>
            </div>
          </div>

          <div class="field">
            <label>البند ${n} – ملاحظات</label>
            <textarea name="البند ${n} – ملاحظات" rows="3" placeholder="ملاحظات مختصرة"></textarea>
          </div>

          <hr />
        </div>
      `;
    }

    createItemPages();
    refreshPages();
    updateProgress();
  </script>
</body>
</html>
